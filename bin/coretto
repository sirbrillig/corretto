#!/usr/bin/env php -q
<?php

require( './vendor/autoload.php' );

$usage = "USAGE: corretto [options] [files]

Options:
 -h, --help			Output usage information
 -R, --reporter <name>		Set a reporter to use (default 'spec')
 --reporters			List available reporters
\n";

$options = getopt( 'hR:g:', [ 'help', 'reporter:', 'reporters', 'grep:' ] );

if ( isset( $options['help'] ) || isset( $options['h'] ) ) {
	echo $usage;
	die;
}

array_shift( $argv );
if ( count( $argv ) < 1 ) {
	echo $usage;
	die;
}

if ( isset( $options['reporters'] ) ) {
	echo "Available reporters:\n";
	$reporters = [ 'base', 'spec' ];
	array_map( function( $reporter ) {
		echo $reporter . "\n";
	}, $reporters );
	exit;
}
$reporter = 'base';
if ( isset( $options['R'] ) ) {
	$reporter = $options['R'];
}
if ( isset( $options['reporter'] ) ) {
	$reporter = $options['reporter'];
}

// Load test files
$loadFile = function( $fileName ) use ( &$loadFiles ) {
	if ( $fileName[0] === '.' ) {
		return;
	}
	if ( is_dir( $fileName ) ) {
		$addDirName = function( $file ) use ( &$fileName ) {
			return $fileName . DIRECTORY_SEPARATOR . $file;
		};
		$dirFiles = array_map( $addDirName, array_diff( scandir( $fileName ), array( '..', '.' ) ) );
		$loadFiles( $dirFiles );
		return;
	}
	if ( preg_match( '/\.php$/', $fileName ) ) {
		include( $fileName );
	}
};
$loadFiles = function( $files ) use ( &$loadFile ) {
	array_map( $loadFile, $files );
};

// Start runner
$root = new \Corretto\Runner();
if ( isset( $options['g'] ) ) {
	$root->grep = $options['g'];
}
if ( isset( $options['grep'] ) ) {
	$root->grep = $options['grep'];
}
\Corretto\setRunner( $root );
$loadFiles( $argv );
// TODO: can we make this dynamic?
switch( $reporter ) {
	case 'base':
		new \Corretto\Reporters\Base( $root );
		break;
	case 'spec':
		new \Corretto\Reporters\Spec( $root );
		break;
	default:
		new \Corretto\Reporters\Spec( $root );
		break;
}
$root->run();
